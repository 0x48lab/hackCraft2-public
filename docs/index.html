<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- キャッシュ制御を強化 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- 自動更新 -->
    <meta http-equiv="refresh" content="300">
    <title>hackCraft2 - Minecraft Modding Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .hero {
            background-color: #2c3e50;
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }
        .feature-card {
            margin-bottom: 2rem;
            transition: transform 0.3s;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .download-section {
            background-color: #f8f9fa;
            padding: 3rem 0;
            margin: 2rem 0;
        }
        .changelog {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .changelog h6 {
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .changelog-details {
            border-top: 1px solid #dee2e6;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        .changelog-container {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">hackCraft2</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#features">機能</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#download">ダウンロード</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#getting-started">始め方</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero">
        <div class="container text-center">
            <h1 class="display-4">hackCraft2</h1>
            <p class="lead">Minecraftの新しいModdingプラットフォーム</p>
        </div>
    </div>

    <div class="container">
        <section id="features" class="mb-5">
            <h2 class="text-center mb-4">主な機能</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">ビジュアルプログラミング</h5>
                            <p class="card-text">Scratchベースのビジュアルプログラミング環境で、直感的にModを作成できます。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">3Dプレビュー</h5>
                            <p class="card-text">作成したModの3Dモデルをリアルタイムでプレビューできます。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">コードエディタ</h5>
                            <p class="card-text">高度な機能が必要な場合は、コードエディタで直接プログラミングも可能です。</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="download" class="download-section">
            <div class="container">
                <h2 class="text-center mb-4">ダウンロード</h2>
                <div class="row justify-content-center">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-lightning-charge"></i> 最新ビルド
                                </h5>
                                <p class="card-text">最新の開発ビルドをダウンロードできます。最新の機能や修正が含まれていますが、安定性は保証されません。</p>
                                <div id="latest-build">
                                    <p class="text-muted">ビルド情報を読み込み中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-tags"></i> 安定版リリース
                                </h5>
                                <p class="card-text">タグ付きの安定版リリースをダウンロードできます。テスト済みで安定した動作が期待できるバージョンです。</p>
                                <div id="stable-release">
                                    <p class="text-muted">リリース情報を読み込み中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-clock-history"></i> 過去のリリース
                                </h5>
                                <div id="release-history">
                                    <p class="text-muted">リリース履歴を読み込み中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="getting-started" class="mb-5">
            <h2 class="text-center mb-4">始め方</h2>
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">
                                <i class="bi bi-server"></i> サーバーセットアップ手順
                            </h3>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> この手順では、Paperサーバーを使用することを推奨しています。
                                Paperは高性能で安定したサーバーソフトウェアです。
                            </div>
                            <div class="steps">
                                <h4 class="mt-4">1. Paperサーバーのインストール</h4>
                                <ol>
                                    <li>
                                        <a href="https://papermc.io/downloads" target="_blank">Paperのダウンロードページ</a>から最新版のPaperをダウンロード
                                        <ul>
                                            <li>推奨バージョン: Minecraft 1.24.4(2025年6月10日現在)</li>
                                            <li>ダウンロードしたjarファイルを任意のディレクトリに配置</li>
                                        </ul>
                                    </li>
                                    <li>
                                        サーバーの初期設定
                                        <ul>
                                            <li>jarファイルをダブルクリックして実行（初回起動）</li>
                                            <li><code>eula.txt</code>を開き、<code>eula=true</code>に変更</li>
                                            <li><code>server.properties</code>でサーバー設定を調整（必要に応じて）</li>
                                        </ul>
                                    </li>
                                </ol>

                                <h4 class="mt-4">2. hackCraft2プラグインのインストール</h4>
                                <ol>
                                    <li>
                                        サーバーの<code>plugins</code>フォルダを作成
                                        <ul>
                                            <li>Paperサーバーのルートディレクトリに<code>plugins</code>フォルダを作成</li>
                                        </ul>
                                    </li>
                                    <li>
                                        hackCraft2プラグインの配置
                                        <ul>
                                            <li>上記の「ダウンロード」セクションから安定版またはリリース版をダウンロード</li>
                                            <li>ダウンロードしたjarファイルを<code>plugins</code>フォルダに配置</li>
                                        </ul>
                                    </li>
                                </ol>

                                <h4 class="mt-4">3. サーバーの起動</h4>
                                <ol>
                                    <li>
                                        サーバーの起動
                                        <ul>
                                            <li>Paperのjarファイルを再度実行してサーバーを起動</li>
                                            <li>初回起動時はプラグインの初期化に時間がかかる場合があります</li>
                                        </ul>
                                    </li>
                                    <li>
                                        動作確認
                                        <ul>
                                            <li>サーバーが正常に起動したら、Minecraftクライアントから接続</li>
                                            <li>サーバーコンソールで<code>/plugins</code>コマンドを実行し、hackCraft2が正常に読み込まれていることを確認</li>
                                        </ul>
                                    </li>
                                </ol>

                                <div class="alert alert-warning mt-4">
                                    <h5><i class="bi bi-exclamation-triangle"></i> 注意事項</h5>
                                    <ul class="mb-0">
                                        <li>サーバーのメモリ割り当ては最低4GB以上を推奨</li>
                                        <li>初回起動時は<code>server.properties</code>の<code>online-mode</code>を<code>false</code>に設定することを推奨（開発時）</li>
                                        <li>本番環境では適切なセキュリティ設定を行ってください</li>
                                    </ul>
                                </div>

                                <div class="alert alert-info mt-4">
                                    <h5><i class="bi bi-lightbulb"></i> トラブルシューティング</h5>
                                    <ul class="mb-0">
                                        <li>サーバーが起動しない場合は、Javaのバージョンが17以上であることを確認</li>
                                        <li>プラグインが読み込まれない場合は、jarファイルが正しい<code>plugins</code>フォルダに配置されているか確認</li>
                                        <li>エラーメッセージが表示される場合は、サーバーのログ（<code>logs/latest.log</code>）を確認</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-dark text-light py-4">
        <div class="container text-center">
            <p>&copy; 2024 hackCraft2. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // キャッシュを無効化してデータを取得する共通関数
        const fetchWithTimeout = (url, timeout = 5000) => {
            return Promise.race([
                fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`${url}の取得に失敗しました (${response.status})`);
                    }
                    return response.json();
                }),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(`${url}の取得がタイムアウトしました`)), timeout)
                )
            ]);
        };

        const formatFileSize = (bytes) => {
            if (!bytes) return '-';
            return `${(bytes / (1024 * 1024)).toFixed(2)}MB`;
        };

        const formatDate = (dateString) => {
            if (!dateString) return '日付情報なし';
            return new Date(dateString).toLocaleDateString('ja-JP');
        };

        const createBuildCard = (buildInfo, isStable = false) => {
            if (!buildInfo) return '';

            const badgeClass = isStable ? 'bg-success' : 'bg-warning';
            const badgeText = isStable ? '安定版' : '最新ビルド';
            
            // 新しいstable.jsonフォーマットに対応
            const downloadUrl = buildInfo.download_url || buildInfo.assets?.[0]?.browser_download_url;
            const fileName = buildInfo.jar_filename || buildInfo.assets?.[0]?.name || 'hackCraft2.jar';
            const fileSize = formatFileSize(buildInfo.jar_size || buildInfo.assets?.[0]?.size);
            const releaseDate = formatDate(buildInfo.release_date || buildInfo.published_at);
            
            // ビルド番号とバージョンの取得
            let buildNumber = 'N/A';
            let version = 'N/A';
            
            if (buildInfo.build_number) {
                buildNumber = buildInfo.build_number;
                version = buildInfo.version || buildInfo.release_tag || `stable-${buildNumber}`;
            } else if (buildInfo.commit_hash) {
                const hashParts = buildInfo.commit_hash.split('-');
                buildNumber = hashParts[1] || 'N/A';
                version = buildInfo.commit_hash;
            }

            // コミットハッシュの取得
            const commitHash = buildInfo.public_commit_hash || buildInfo.source_commit_hash;
            const showChangelogButton = commitHash && commitHash.length > 0;

            return `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                ${buildInfo.name || `Build ${buildNumber}`}
                                <span class="badge ${badgeClass} ms-2">${badgeText}</span>
                            </h6>
                            <p class="mb-1 small text-muted">
                                ビルド番号: ${buildNumber} | バージョン: ${version}
                            </p>
                            ${buildInfo.paper_version ? `<p class="mb-1 small text-muted">Paper: ${buildInfo.paper_version}</p>` : ''}
                            ${buildInfo.body ? `<p class="mb-1 small text-muted">${buildInfo.body.split('\n')[0]}</p>` : ''}
                            ${commitHash ? `<p class="mb-1 small text-muted">コミット: <code>${commitHash.substring(0, 8)}</code></p>` : ''}
                        </div>
                        <small class="text-muted">${releaseDate}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                            <small class="text-muted">${fileSize}</small>
                        </div>
                        <div>
                            ${showChangelogButton ? `
                                <button class="btn btn-outline-info btn-sm me-2" onclick="showChangelog('${commitHash}', this)">
                                    <i class="bi bi-file-text"></i> 変更ログ
                                </button>
                            ` : ''}
                            <a href="${downloadUrl}" class="btn btn-primary btn-sm" download="${fileName}">
                                <i class="bi bi-download"></i> ダウンロード
                            </a>
                        </div>
                    </div>
                    ${showChangelogButton ? `
                        <div id="changelog-${commitHash}" class="changelog-container mt-3" style="display: none;">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                                <span class="ms-2">変更ログを読み込み中...</span>
                            </div>
                        </div>
                    ` : ''}
                </div>`;
        };

        const loadPastBuilds = async () => {
            try {
                // 現在のstable.jsonからビルド番号を取得
                const stableData = await fetchWithTimeout('stable.json');
                let currentBuildNumber = 0;
                
                // 新しいstable.jsonフォーマットに対応
                if (stableData.build_number) {
                    currentBuildNumber = stableData.build_number;
                } else if (stableData.latest?.commit_hash) {
                    // 古いフォーマット（latestプロパティがある場合）
                    const hashParts = stableData.latest.commit_hash.split('-');
                    currentBuildNumber = parseInt(hashParts[1]) || 0;
                }
                
                const pastBuilds = [];
                
                // 過去のビルド情報を取得（現在のビルド番号から逆順で取得）
                for (let i = currentBuildNumber - 1; i >= Math.max(1, currentBuildNumber - 10); i--) {
                    try {
                        const buildData = await fetchWithTimeout(`downloads/latest/stable-${i}.json`);
                        if (buildData) {
                            pastBuilds.push(buildData);
                        }
                    } catch (error) {
                        // ファイルが存在しない場合はスキップ
                        console.log(`stable-${i}.json not found`);
                    }
                }
                
                return pastBuilds;
            } catch (error) {
                console.log('過去のビルド情報の取得に失敗:', error);
                return [];
            }
        };

        const updateReleaseInfo = async () => {
            try {
                // stable.jsonから最新ビルド情報を取得
                const stableData = await fetchWithTimeout('stable.json');
                
                // 最新ビルドの表示を更新
                const latestBuildDiv = document.getElementById('latest-build');
                if (stableData.latest) {
                    // 古いフォーマット（latestプロパティがある場合）
                    latestBuildDiv.innerHTML = `
                        <div class="list-group">
                            ${createBuildCard(stableData.latest, false)}
                        </div>`;
                } else if (stableData.build_number) {
                    // 新しいフォーマット（直接プロパティがある場合）
                    latestBuildDiv.innerHTML = `
                        <div class="list-group">
                            ${createBuildCard(stableData, false)}
                        </div>`;
                } else {
                    latestBuildDiv.innerHTML = '<p class="text-muted">最新ビルドの情報が見つかりませんでした。</p>';
                }

                // release.jsonから安定版リリース情報を取得（存在する場合）
                const stableReleaseDiv = document.getElementById('stable-release');
                try {
                    const releaseData = await fetchWithTimeout('release.json');
                    if (releaseData && releaseData.latest) {
                        // 古いフォーマット（latestプロパティがある場合）
                        stableReleaseDiv.innerHTML = `
                            <div class="list-group">
                                ${createBuildCard(releaseData.latest, true)}
                            </div>`;
                    } else if (releaseData && releaseData.build_number) {
                        // 新しいフォーマット（直接プロパティがある場合）
                        stableReleaseDiv.innerHTML = `
                            <div class="list-group">
                                ${createBuildCard(releaseData, true)}
                            </div>`;
                    } else {
                        stableReleaseDiv.innerHTML = '<p class="text-muted">安定版リリースの情報は現在準備中です。</p>';
                    }
                } catch (error) {
                    console.log('release.jsonが見つかりません:', error);
                    stableReleaseDiv.innerHTML = '<p class="text-muted">安定版リリースの情報は現在準備中です。</p>';
                }

                // 過去のビルド情報を取得
                const pastBuilds = await loadPastBuilds();
                const releaseHistoryDiv = document.getElementById('release-history');
                
                if (pastBuilds.length > 0) {
                    const pastBuildsHtml = pastBuilds
                        .sort((a, b) => {
                            const dateA = new Date(a.release_date || a.published_at);
                            const dateB = new Date(b.release_date || b.published_at);
                            return dateB - dateA;
                        })
                        .slice(0, 10) // 最新10件を表示
                        .map(build => createBuildCard(build, false))
                        .join('');
                    
                    releaseHistoryDiv.innerHTML = `
                        <div class="list-group">
                            ${pastBuildsHtml}
                        </div>`;
                } else {
                    releaseHistoryDiv.innerHTML = '<p class="text-muted">過去のビルド情報は現在準備中です。</p>';
                }

            } catch (error) {
                console.error('リリース情報の更新に失敗しました:', error);
                ['latest-build', 'stable-release', 'release-history'].forEach(id => {
                    const div = document.getElementById(id);
                    if (div) {
                        div.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> リリース情報の取得に失敗しました
                            </div>`;
                    }
                });
            }
        };

        // ページ読み込み時にリリース情報を表示
        document.addEventListener('DOMContentLoaded', () => {
            updateReleaseInfo();
            // 5分ごとに自動更新
            setInterval(updateReleaseInfo, 300000);
        });

        // コミット情報を取得（ローカルJSONファイルから）
        const fetchCommitInfo = async (commitHash) => {
            try {
                // コミット情報をローカルJSONファイルから取得
                const response = await fetchWithTimeout(`commits/${commitHash}.json`);
                return response;
            } catch (error) {
                console.log('コミット情報ファイルが見つかりません:', error);
                
                // フォールバック: GitHubのコミットページへのリンクを提供
                return {
                    commit: {
                        message: `コミット ${commitHash.substring(0, 8)}`,
                        author: {
                            name: 'hackCraft2',
                            date: new Date().toISOString()
                        }
                    },
                    html_url: `https://github.com/0x48lab/hackCraft2-public/commit/${commitHash}`,
                    isFallback: true
                };
            }
        };

        // コミット情報から変更ログを生成
        const generateChangelog = (commitInfo) => {
            if (!commitInfo || !commitInfo.commit) {
                return '変更ログの情報が取得できませんでした。';
            }

            const message = commitInfo.commit.message;
            const author = commitInfo.commit.author.name;
            const date = new Date(commitInfo.commit.author.date).toLocaleDateString('ja-JP');
            
            // コミットメッセージを行ごとに分割
            const lines = message.split('\n').filter(line => line.trim());
            const title = lines[0];
            const details = lines.slice(1);

            let changelog = `
                <div class="changelog">
                    <h6 class="mb-2">${title}</h6>
                    <div class="small text-muted mb-2">
                        <i class="bi bi-person"></i> ${author} | 
                        <i class="bi bi-calendar"></i> ${date}
                    </div>`;

            if (details.length > 0) {
                changelog += `
                    <div class="changelog-details">
                        ${details.map(detail => `<p class="mb-1 small">${detail}</p>`).join('')}
                    </div>`;
            }

            changelog += '</div>';
            return changelog;
        };

        // 変更ログを表示する関数
        const showChangelog = async (commitHash, button) => {
            const containerId = `changelog-${commitHash}`;
            const container = document.getElementById(containerId);
            
            if (!container) return;

            // ボタンの状態を更新
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> 読み込み中...';
            button.disabled = true;

            try {
                // コンテナを表示
                container.style.display = 'block';

                // コミット情報を取得
                const commitInfo = await fetchCommitInfo(commitHash);
                
                if (commitInfo && commitInfo.commit) {
                    // フォールバックの場合（ローカルファイルが見つからない場合）
                    if (commitInfo.isFallback) {
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> このコミットの詳細情報は現在利用できません。
                                <br><small>コミットハッシュ: <code>${commitHash.substring(0, 8)}</code></small>
                                <br><a href="${commitInfo.html_url}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">
                                    <i class="bi bi-github"></i> GitHubで詳細を確認
                                </a>
                            </div>`;
                    } else {
                        // 変更ログを生成して表示
                        const changelog = generateChangelog(commitInfo);
                        container.innerHTML = changelog;
                    }
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> このコミットの詳細情報は現在利用できません。
                            <br><small>コミットハッシュ: <code>${commitHash.substring(0, 8)}</code></small>
                        </div>`;
                }
            } catch (error) {
                console.error('変更ログの表示に失敗:', error);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 変更ログの表示に失敗しました
                        <br><small>コミットハッシュ: <code>${commitHash.substring(0, 8)}</code></small>
                    </div>`;
            } finally {
                // ボタンを元の状態に戻す
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };
    </script>
</body>
</html> 